___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "comprend.tag.consent-mode",
  "version": 1,
  "securityGroups": [],
  "displayName": "Consent Mode",
  "brand": {
    "id": "comprend",
    "displayName": "Comprend",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "🔹Set default consent.\n\u003cbr\u003e\n🔹Set updated consent.\n\u003cbr\u003e\n🔹Set region-specific behaviour.\n\u003cbr\u003e\n🔹Set URL passthrough.\n\u003cbr\u003e\n🔹Set ads data redaction.\n\u003cbr\u003e\n🔹Microsoft consent integrations.",
  "containerContexts": [
    "WEB"
  ],
  "categories": [
    "UTILITY"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "command",
    "displayName": "Consent Command",
    "selectItems": [
      {
        "value": "default",
        "displayValue": "default"
      },
      {
        "value": "update",
        "displayValue": "update"
      }
    ],
    "simpleValueType": true,
    "help": "⚙️ \u003cb\u003eConsent Command\u003c/b\u003e\u003cbr\u003e\nSet a default or updated value for each consent type you are using. The consent state is guaranteed to be processed in this container before any queued data layer items are processed.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003edefault\u003c/b\u003e\n\u003cbr\u003e\nSet a default consent state for each consent type using the \u003ca href\u003d\"https://developers.google.com/tag-platform/tag-manager/templates/api#setdefaultconsentstate\"\u003esetDefaultConsentState\u003c/a\u003e API. \n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eupdate\u003c/b\u003e\n\u003cbr\u003e\nSet an updated consent state for each consent type using the \u003ca href\u003d\"https://developers.google.com/tag-platform/tag-manager/templates/api#updateconsentstate\"\u003eupdateConsentState\u003c/a\u003e API.",
    "defaultValue": "default",
    "alwaysInSummary": true
  },
  {
    "type": "GROUP",
    "name": "regionSettings",
    "displayName": "Region Specific Behaviour",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "regions",
        "displayName": "Regions",
        "simpleValueType": true,
        "help": "🌍 \u003cb\u003eRegions\u003c/b\u003e\n\u003cbr\u003e\nProvide a comma-separated list of country codes and/or subdivision codes according to \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-2\"\u003eISO 3166-2\u003c/a\u003e.",
        "valueHint": "SE,DK,DE ...etc."
      },
      {
        "type": "CHECKBOX",
        "name": "includeEEA",
        "checkboxText": "EEA Regions",
        "simpleValueType": true,
        "help": "🌍 \u003cb\u003eInclude EEA Regions\u003c/b\u003e\n\u003cbr\u003e\nAutomatically include all regions from the \u003ca href\u003d\"https://ec.europa.eu/eurostat/statistics-explained/index.php?title\u003dGlossary:European_Economic_Area_(EEA)\"\u003eEuropean Economic Area\u003c/a\u003e in the list of regions.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/guides/consent?consentmode\u003dadvanced#region-specific-behavior\"\u003eConsent Mode - Advanced - Region-Specific Behavior\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/tag-manager/templates/consent-apis#regional-behavior\"\u003eConsent Mode - Templates - Region-Specific Behavior\u003c/a\u003e"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "command",
        "paramValue": "default",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettings",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "getStateFromVar",
        "checkboxText": "Read Settings From Variable",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "SELECT",
            "name": "consentStateVar",
            "displayName": "",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "getStateFromVar",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ],
        "help": "⚙️ \u003cb\u003eRead Settings From Variable\u003c/b\u003e\n\u003cbr\u003e\nProvide an object with key-value pairs that represent the desired consent state (see example below).\n\u003cbr\u003e\u003cbr\u003e\nA consent type will be set to \u003cb\u003egranted\u003c/b\u003e if it has a value of:\n\u003cbr\u003e\n🔹 \u003cb\u003e\"granted\"\u003c/b\u003e (\u003cem\u003estring\u003c/em\u003e)\u003cbr\u003e\n🔹 \u003cb\u003e\"true\"\u003c/b\u003e (\u003cem\u003estring\u003c/em\u003e)\u003cbr\u003e\n🔹 \u0026nbsp;\u003cb\u003etrue\u003c/b\u003e (\u003cem\u003eboolean\u003c/em\u003e)\n\u003cbr\u003e\u003cbr\u003e\nA consent type will be set to \u003cb\u003edenied\u003c/b\u003e if it has a value of:\n\u003cbr\u003e\n🔹 \u003cb\u003e\"denied\"\u003c/b\u003e (\u003cem\u003estring\u003c/em\u003e)\u003cbr\u003e\n🔹 \u003cb\u003e\"false\"\u003c/b\u003e (\u003cem\u003estring\u003c/em\u003e)\u003cbr\u003e\n🔹 \u0026nbsp;\u003cb\u003efalse\u003c/b\u003e (\u003cem\u003eboolean\u003c/em\u003e)\n\u003cbr\u003e\u003cbr\u003e\nIf a consent type has any other value than what is listed above it will be regarded as \u003cb\u003e(not set)\u003c/b\u003e and excluded from the resulting consent command.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eExample\u003c/b\u003e\n\u003cbr\u003e\nIf the input variable has the following value:\u003cbr\u003e\n{\n\u003cbr\u003e\u0026emsp;\nanalytics_storage:\u0026emsp;\u0026emsp;\u0026emsp;\"granted\",\n\u003cbr\u003e\u0026emsp;\nad_user_data:\u0026emsp;\u0026emsp;\u0026emsp;\u0026emsp;\u0026emsp;\"denied\",\n\u003cbr\u003e\u0026emsp;\nad_personalization:\u0026emsp;\u0026emsp;\u0026nbsp;\u0026nbsp;\"true\",\n\u003cbr\u003e\u0026emsp;\npersonalization_storage: \u0026nbsp;false,\n\u003cbr\u003e\u0026emsp;\nfunctionality_storage:\u0026emsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;undefined,\n\u003cbr\u003e\u0026emsp;\nsecurity_storage:\u0026emsp;\u0026emsp;\u0026emsp;\u0026nbsp;\u0026nbsp;\"INVALID\"\n\u003cbr\u003e\n}\n\u003cbr\u003e\u003cbr\u003e\nThe resulting consent state will be:\n\u003cbr\u003e\n{\n\u003cbr\u003e\u0026emsp;\nanalytics_storage:\u0026emsp;\u0026emsp;\u0026emsp;\"granted\",\n\u003cbr\u003e\u0026emsp;\nad_user_data:\u0026emsp;\u0026emsp;\u0026emsp;\u0026emsp;\u0026emsp;\"denied\",\n\u003cbr\u003e\u0026emsp;\nad_personalization:\u0026emsp;\u0026emsp;\u0026nbsp;\u0026nbsp;\"granted\",\n\u003cbr\u003e\u0026emsp;\npersonalization_storage: \"denied\",\n\u003cbr\u003e\n}"
      },
      {
        "type": "GROUP",
        "name": "consentTypes",
        "displayName": "Consent Types",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SELECT",
            "name": "analytics_storage",
            "displayName": "analytics_storage",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "granted",
                "displayValue": "granted"
              },
              {
                "value": "denied",
                "displayValue": "denied"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "denied",
            "help": "⚙️ \u003cb\u003eanalytics_storage\u003c/b\u003e\u003cbr\u003e\nEnables storage, such as cookies (web) or device identifiers (apps), related to analytics, for example, visit duration.\u003cbr\u003e\u003cbr\u003e\n\n\u003cb\u003eIf denied:\u003c/b\u003e\u003cbr\u003e\n🔹 Google tags will not read or write first-party \u003ca href\u003d\"https://support.google.com/analytics/answer/11397207\"\u003eanalytics cookies\u003c/a\u003e or app identifiers.\u003cbr\u003e\n🔹 Cookieless pings (web) or signals (apps) will be sent to Google Analytics for basic measurement and modeling purposes (advanced consent mode).\u003cbr\u003e\n🔹 Google Analytics 4 will use cookieless pings for \u003ca href\u003d\"https://support.google.com/analytics/answer/11161109\"\u003ebehavioral modeling\u003c/a\u003e (advanced consent mode).\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types:~:text\u003dg.%2C%20GCLID%20/%20DCLID)-,analytics_storage,-denied\"\u003eConsent Mode Overview - Tag Behaviour\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://support.google.com/analytics/answer/9976101?hl\u003den\u0026sjid\u003d11449020363400386941-EU#behavior:~:text\u003dConsent%20mode%20behavior\"\u003eAnalytics - Consent Mode Behavior\u003c/a\u003e",
            "notSetText": "(not set)",
            "alwaysInSummary": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY",
                "errorMessage": "This value cannot be \u003cb\u003e\"(not set)\"\u003c/b\u003e while consent integration with \u003cb\u003eMicrosoft Clarity\u003c/b\u003e is enabled.",
                "enablingConditions": [
                  {
                    "paramName": "extMsClarity",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ]
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "ad_storage",
            "displayName": "ad_storage",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "granted",
                "displayValue": "granted"
              },
              {
                "value": "denied",
                "displayValue": "denied"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "denied",
            "help": "⚙️ \u003cb\u003ead_storage\u003c/b\u003e\u003cbr\u003e\nEnables storage, such as cookies (web) or device identifiers (apps), related to advertising.\u003cbr\u003e\u003cbr\u003e\n\n\u003cb\u003eIf denied:\u003c/b\u003e\u003cbr\u003e\n🔹 No new cookies or device identifiers pertaining to advertising may be written.\u003cbr\u003e\n🔹 No existing advertising cookies or device identifiers may be read.\u003cbr\u003e\n🔹 Requests are sent through a different domain to avoid previously set third-party cookies from being sent in request headers.\u003cbr\u003e\n🔹 Google Analytics will not read or write Google Ads cookies, and Google signals features will not accumulate data for this traffic.\u003cbr\u003e\n🔹 Ads products truncate IP addresses at collection.\u003cbr\u003e\n🔹 IP addresses are used to derive IP country and then immediately deleted upon collection.\u003cbr\u003e\n🔹 Full page URL is collected, and may include ad-click information in URL parameters (e.g., GCLID / DCLID). Ad-click information will only be used to approximate accurate traffic measurement.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types:~:text\u003dfirst%20party%20data-,ad_storage,-denied\"\u003eConsent Mode Overview - Tag Behaviour\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://support.google.com/analytics/answer/9976101?hl\u003den\u0026sjid\u003d11449020363400386941-EU#behavior:~:text\u003dConsent%20mode%20behavior\"\u003eAnalytics - Consent Mode Behavior\u003c/a\u003e",
            "notSetText": "(not set)",
            "alwaysInSummary": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY",
                "errorMessage": "This value cannot be \u003cb\u003e\"(not set)\"\u003c/b\u003e while consent integration with \u003cb\u003eMicrosoft Advertising (UET)\u003c/b\u003e is enabled.",
                "enablingConditions": [
                  {
                    "paramName": "extMsAdvertising",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ]
              },
              {
                "type": "NON_EMPTY",
                "errorMessage": "This value cannot be \u003cb\u003e\"(not set)\"\u003c/b\u003e while consent integration with \u003cb\u003eMicrosoft Invest(UET)\u003c/b\u003e is enabled.",
                "enablingConditions": [
                  {
                    "paramName": "extPixie",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ]
              }
            ]
          },
          {
            "type": "SELECT",
            "name": "ad_user_data",
            "displayName": "ad_user_data",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "granted",
                "displayValue": "granted"
              },
              {
                "value": "denied",
                "displayValue": "denied"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "denied",
            "help": "⚙️ \u003cb\u003ead_user_data\u003c/b\u003e\u003cbr\u003e\nSets consent for sending user data to Google for online advertising purposes.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eIf denied:\u003c/b\u003e\u003cbr\u003e\nPersonal data collection for online advertising is disabled, including:\u003cbr\u003e\n🔹 user_id\u003cbr\u003e\n🔹 Hashed first party data (enhanced conversions)\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types:~:text\u003dGoogle%27s%20advertising%20products-,ad_user_data,-denied\"\u003eConsent Mode Overview - Tag Behaviour\u003c/a\u003e",
            "notSetText": "(not set)",
            "alwaysInSummary": true
          },
          {
            "type": "SELECT",
            "name": "ad_personalization",
            "displayName": "ad_personalization",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "granted",
                "displayValue": "granted"
              },
              {
                "value": "denied",
                "displayValue": "denied"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "denied",
            "help": "⚙️ \u003cb\u003ead_personalization\u003c/b\u003e\u003cbr\u003e\nSets consent for personalized advertising.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eIf denied:\u003c/b\u003e\u003cbr\u003e\nThe following features won\u0027t receive data:\u003cbr\u003e\n🔹 Remarketing in Google Ads\u003cbr\u003e\n🔹 Remarketing in Display \u0026 Video 360\u003cbr\u003e\n🔹 Remarketing in Search Ads 360\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types:~:text\u003d)%20are%20accessible.-,ad_personalization,-denied\"\u003eConsent Mode Overview - Tag Behaviour\u003c/a\u003e",
            "notSetText": "(not set)",
            "alwaysInSummary": true
          },
          {
            "type": "GROUP",
            "name": "additionalTypes",
            "displayName": "Additional Consent Types",
            "groupStyle": "ZIPPY_OPEN_ON_PARAM",
            "subParams": [
              {
                "type": "SELECT",
                "name": "personalization_storage",
                "displayName": "personalization_storage",
                "macrosInSelect": true,
                "selectItems": [
                  {
                    "value": "granted",
                    "displayValue": "granted"
                  },
                  {
                    "value": "denied",
                    "displayValue": "denied"
                  }
                ],
                "simpleValueType": true,
                "notSetText": "(not set)",
                "help": "⚙️ \u003cb\u003epersonalization_storage\u003c/b\u003e\u003cbr\u003e\nEnables storage related to personalization, for example, video recommendations.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e"
              },
              {
                "type": "SELECT",
                "name": "functionality_storage",
                "displayName": "functionality_storage",
                "macrosInSelect": true,
                "selectItems": [
                  {
                    "value": "granted",
                    "displayValue": "granted"
                  },
                  {
                    "value": "denied",
                    "displayValue": "denied"
                  }
                ],
                "simpleValueType": true,
                "notSetText": "(not set)",
                "help": "⚙️ \u003cb\u003efunctionality_storage\u003c/b\u003e\u003cbr\u003e\nEnables storage related to personalization, for example, video recommendations.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e"
              },
              {
                "type": "SELECT",
                "name": "security_storage",
                "displayName": "security_storage",
                "macrosInSelect": true,
                "selectItems": [
                  {
                    "value": "granted",
                    "displayValue": "granted"
                  },
                  {
                    "value": "denied",
                    "displayValue": "denied"
                  }
                ],
                "simpleValueType": true,
                "notSetText": "(not set)",
                "help": "⚙️ \u003cb\u003esecurity_storage\u003c/b\u003e\u003cbr\u003e\nEnables storage related to security such as authentication functionality, fraud prevention, and other user protection.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types\"\u003eConsent Mode Overview - Consent Types\u003c/a\u003e"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "getStateFromVar",
            "paramValue": false,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalSettings",
    "displayName": "Additional Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "waitForUpdate",
        "checkboxText": "Wait For Update",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "wait_for_update",
            "displayName": "Time to wait (milliseconds)",
            "simpleValueType": true,
            "valueUnit": "ms",
            "help": "⌛ \u003cb\u003eTime to Wait\u003c/b\u003e\u003cbr\u003e\nHow long to wait (\u003cem\u003ein milliseconds\u003c/em\u003e) for an \u003cb\u003eupdate\u003c/b\u003e command before firing queued up Google tags.",
            "enablingConditions": [
              {
                "paramName": "waitForUpdate",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_NEGATIVE_NUMBER"
              }
            ],
            "valueHint": "milliseconds",
            "defaultValue": 500,
            "alwaysInSummary": true
          }
        ],
        "help": "⚙️ \u003cb\u003eWait For Update\u003c/b\u003e\n\u003cbr\u003e\nEnabling this setting allows you to specify a millisecond value to control how long to delay queued up Google tags from sending data. This gives time for an \u003cb\u003eupdate\u003c/b\u003e command to be registered.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/guides/consent?consentmode\u003dadvanced#integrate_with_asynchronous_consent_management_platforms:~:text\u003dOptional%3A-,Integrate%20with%20asynchronous%20consent%20management%20platforms,-If%20your%20banner\"\u003eConsent Mode - Integrate with Asynchronous CMP\u003c/a\u003e",
        "enablingConditions": [
          {
            "paramName": "command",
            "paramValue": "default",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "url_passthrough",
        "checkboxText": "URL Passthrough",
        "simpleValueType": true,
        "help": "⚙️ \u003cb\u003eURL Passthrough\u003c/b\u003e\n\u003cbr\u003e\nWhen \u003cb\u003ead_storage\u003c/b\u003e is \u003cb\u003edenied\u003c/b\u003e, URL passthrough can be used to persist information about ad clicks from one page to the next by appending it to the URL as URL parameters.\n\u003cbr\u003e\u003cbr\u003e\nSimilarly, if \u003cb\u003eanalytics_storage\u003c/b\u003e is set to \u003cb\u003edenied\u003c/b\u003e, URL passthrough can be used to persist event- and session-based analytics (including key events) across pages without the use of cookies.\n\u003cbr\u003e\u003cbr\u003e\nThe following conditions must be met in order to use URL passthrough:\n\u003cbr\u003e\n✔️ Consent mode is implemented on the page.\n\u003cbr\u003e\n✔️ Your Google tag is consent-aware and present on the page (\u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#advanced_consent_mode\"\u003eadvanced consent mode\u003c/a\u003e).\n\u003cbr\u003e\n✔️ The outgoing link refers to the same domain as the current page\u0027s domain (internal page navigation).\n\u003cbr\u003e\u003cbr\u003e\nWhen using URL passthrough, a few query parameters may be appended to links as users navigate through pages on your website:\n\u003cbr\u003e\n🔹 gclid\n\u003cbr\u003e\n🔹 dclid\n\u003cbr\u003e\n🔹 gclsrc\n\u003cbr\u003e\n🔹 _gl\n\u003cbr\u003e\n🔹 wbraid\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/guides/consent?consentmode\u003dadvanced#passthroughs\"\u003eConsent Mode - URL Passthrough \u003c/a\u003e"
      },
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Ads Data Redaction",
        "simpleValueType": true,
        "help": "⚙️ \u003cb\u003eAds Data Redaction\u003c/b\u003e\n\u003cbr\u003e\nEnable this setting to further redact your ads data when consent for ad_storage is denied.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eIf enabled and ad_storage is denied:\u003c/b\u003e\n\u003cbr\u003e\n🔹 Requests are sent through a different domain to avoid existing third-party cookies from being included in request headers.\n\u003cbr\u003e\n🔹 Ad-click identifiers (e.g., gclid / dclid) in consent and key event pings are redacted.\n\u003cbr\u003e\n🔹 Page URLs with ad-click identifiers are redacted.\n\u003cbr\u003e\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/tag-manager/templates/consent-apis#data-redaction\"\u003eConsent Mode Templates - Redact Ads Data\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://developers.google.com/tag-platform/security/concepts/consent-mode#consent-types:~:text\u003dad_storage%20and%20ads_data_redaction\"\u003eConsent Mode Overview - Tag Behaviour\u003c/a\u003e\n\u003cbr\u003e\n🔗 \u003ca href\u003d\"https://support.google.com/analytics/answer/9976101?hl\u003den\u0026sjid\u003d11449020363400386941-EU#behavior:~:text\u003dad_storage%3D%27denied%27%20and%20ads_data_redaction%3D%27true%27\"\u003eAnalytics - Consent Mode Behavior\u003c/a\u003e"
      },
      {
        "type": "CHECKBOX",
        "name": "dataLayerEvent",
        "checkboxText": "Data Layer Event",
        "simpleValueType": true,
        "help": "📢 \u003cb\u003eData Layer Event\u003c/b\u003e\n\u003cbr\u003e\nPush a predefined event to the data layer when consent state is modified by this template. Alternatively, specify a custom event name that better suits the needs of your specific setup.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003ePre-defined event names:\u003c/b\u003e\u003cbr\u003e\n🔹 consent_default\u003cbr\u003e\n🔹 consent_update\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eExample event:\u003c/b\u003e\u003cbr\u003e\ndataLayer.push({\u003cbr\u003e\n\u0026emsp;\nevent: \"\u003cb\u003econsent_\u0026lt;command\u003e\u003c/b\u003e\",\u003cbr\u003e\n\u0026emsp;\n\u003cb\u003econsent_state\u003c/b\u003e: {\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nanalytics_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nad_user_data,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nad_personalization,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\npersonalization_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nfunctionality_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nsecurity_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\n\u003cem\u003ewait_for_update\u003c/em\u003e,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\n\u003cem\u003eregion_specific\u003c/em\u003e (region-specific consent state)\u003cbr\u003e\n\u0026emsp;\n},\u003cbr\u003e\n\u0026emsp;\n\u003cem\u003econsent_state_default\u003c/em\u003e,\u0026emsp;(optional)\u003cbr\u003e\n\u0026emsp;\n\u003cem\u003econsent_state_previous\u003c/em\u003e, (optional)\u003cbr\u003e\n})",
        "subParams": [
          {
            "type": "GROUP",
            "name": "eventDataOptions",
            "groupStyle": "NO_ZIPPY",
            "subParams": [
              {
                "type": "CHECKBOX",
                "name": "includePreviousState",
                "checkboxText": "Include Previous State",
                "simpleValueType": true,
                "help": "⚙️ \u003cb\u003eInclude Previous Consent State\u003c/b\u003e\n\u003cbr\u003e\nIncludes the additional variable \u003cb\u003econsent_state_previous\u003c/b\u003e in the data layer event that is pushed together with the \u003cb\u003eupdate\u003c/b\u003e command. The variable holds information about the consent state that was last set by this template.\n\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eExample event:\u003c/b\u003e\u003cbr\u003e\ndataLayer.push({\u003cbr\u003e\n\u0026emsp;\nevent: \"\u003cb\u003econsent_update\u003c/b\u003e\",\u003cbr\u003e\n\u0026emsp;\nconsent_state, (current consent state)\u003cbr\u003e\n\u0026emsp;\n\u003cb\u003econsent_state_previous\u003c/b\u003e: {\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nanalytics_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nad_user_data,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nad_personalization,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\npersonalization_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nfunctionality_storage,\u003cbr\u003e\n\u0026emsp;\u0026emsp;\nsecurity_storage\u003cbr\u003e\n\u0026emsp;\n\u003c/em\u003e}\u003cbr\u003e\n})",
                "enablingConditions": [
                  {
                    "paramName": "command",
                    "paramValue": "update",
                    "type": "EQUALS"
                  }
                ]
              },
              {
                "type": "CHECKBOX",
                "name": "useCustomEventName",
                "checkboxText": "Custom Event Name",
                "simpleValueType": true,
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "customEventName",
                    "simpleValueType": true,
                    "enablingConditions": [
                      {
                        "paramName": "useCustomEventName",
                        "paramValue": true,
                        "type": "EQUALS"
                      }
                    ],
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY",
                        "errorMessage": "An event name is required"
                      },
                      {
                        "type": "STRING_LENGTH",
                        "args": [
                          1
                        ],
                        "errorMessage": "An event name must have at least one character",
                        "enablingConditions": []
                      }
                    ],
                    "valueHint": "consent_update"
                  }
                ],
                "help": "📢 \u003cb\u003eCustom Event Name\u003c/b\u003e\n\u003cbr\u003e\nSpecify a custom name for the event that is pushed to the data layer when consent is updated by this template."
              }
            ],
            "enablingConditions": [
              {
                "paramName": "dataLayerEvent",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "thirdParty",
        "displayName": "Consent Integrations",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "GROUP",
            "name": "warnThirdParty",
            "groupStyle": "NO_ZIPPY",
            "subParams": [
              {
                "type": "LABEL",
                "name": "warnLabel",
                "displayName": "⚠️ \u003cb\u003eWarning\u003c/b\u003e\n\u003cbr\u003e\nConsent integrations do not support region-specific consent settings.\u003cbr\u003e\u003cbr\u003e",
                "enablingConditions": [
                  {
                    "paramName": "includeEEA",
                    "paramValue": true,
                    "type": "EQUALS"
                  },
                  {
                    "paramName": "regions",
                    "paramValue": "",
                    "type": "PRESENT"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "extMsClarity",
                "paramValue": true,
                "type": "EQUALS"
              },
              {
                "paramName": "extMsAdvertising",
                "paramValue": true,
                "type": "EQUALS"
              },
              {
                "paramName": "extMsInvest",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "extMsClarity",
            "checkboxText": "Microsoft Clarity",
            "simpleValueType": true,
            "help": "\u003cb\u003eMicrosoft Clarity\u003c/b\u003e\u003cbr\u003e\nEnables consent mode integration with Microsoft Clarity.\u003cbr\u003e\u003cbr\u003e\n\nThe integration reads from:\u003cbr\u003e\n\u0026emsp;\u003cb\u003eanalytics_storage\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\nRead more here:\u003cbr\u003e\n\u003ca href\u003d\"https://learn.microsoft.com/en-us/clarity/setup-and-installation/cookie-consent\"\u003ehttps://learn.microsoft.com/en-us/clarity/setup-and-installation/cookie-consent\u003c/a\u003e",
            "valueValidators": []
          },
          {
            "type": "CHECKBOX",
            "name": "extMsAdvertising",
            "checkboxText": "Microsoft Advertising",
            "simpleValueType": true,
            "help": "\u003cb\u003eMicrosoft Advertising\u003c/b\u003e\u003cbr\u003e\nEnables consent mode integration with Microsoft Advertising (also known as \"\u003cem\u003eUniversal Event Tracking (UET)\u003c/em\u003e\" or \"\u003cem\u003eBing Ads\u003c/em\u003e\").\u003cbr\u003e\u003cbr\u003e\n\nThe integration reads from:\u003cbr\u003e\n\u0026emsp;\u003cb\u003ead_storage\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\nRead more here:\u003cbr\u003e\n\u003ca href\u003d\"https://help.ads.microsoft.com/apex/index/3/en/60119\"\u003ehttps://help.ads.microsoft.com/apex/index/3/en/60119\u003c/a\u003e",
            "valueValidators": []
          },
          {
            "type": "CHECKBOX",
            "name": "extMsInvest",
            "checkboxText": "Microsoft Invest",
            "simpleValueType": true,
            "help": "\u003cb\u003eMicrosoft Invest\u003c/b\u003e\u003cbr\u003e\nEnables consent mode integration with Microsoft Invest Universal Pixel (also known as \"\u003cem\u003eXandr Universal Pixel\u003c/em\u003e\" or \"\u003cem\u003epixie.js\u003c/em\u003e\").\u003cbr\u003e\u003cbr\u003e\n\nThe integration reads from:\u003cbr\u003e\n\u0026emsp;\u003cb\u003ead_storage\u003c/b\u003e\u003cbr\u003e\u003cbr\u003e\nRead more here:\u003cbr\u003e\n\u003ca href\u003d\"https://learn.microsoft.com/en-us/xandr/invest/set-up-consent-mode-in-universal-pixel\"\u003ehttps://learn.microsoft.com/en-us/xandr/invest/set-up-consent-mode-in-universal-pixel\u003c/a\u003e",
            "valueValidators": []
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const gtagSet = require('gtagSet');
const makeInteger = require('makeInteger');
const setConsent = {
  'default': require('setDefaultConsentState'),
  'update':  require('updateConsentState')
};

const consentTypes = [
  'analytics_storage',
  'ad_storage',
  'ad_user_data',
  'ad_personalization',
  'personalization_storage',
  'functionality_storage',
  'security_storage'
];

const regionsEEA = [
  'AT',
  'BE',
  'BG',
  'HR',
  'CY',
  'CZ',
  'DK',
  'EE',
  'FI',
  'FR',
  'DE',
  'GR',
  'HU',
  'IE',
  'IT',
  'LV',
  'LT',
  'LU',
  'MT',
  'NL',
  'PL',
  'PT',
  'RO',
  'SK',
  'SI',
  'ES',
  'SE',
  'NO',
  'IS',
  'LI'
];

function getEventMessage(newState) {
  const tplStorage = require('templateStorage');
  const previousState = tplStorage.getItem('previousConsentState');
  
  const mergedState = {};
  consentTypes.forEach(consentType => {
    if (newState[consentType])
      mergedState[consentType] = newState[consentType];
    else if (previousState)
      mergedState[consentType] = previousState[consentType];
  });
  tplStorage.setItem('previousConsentState', mergedState);
  
  return {
    'event': data.customEventName ? data.customEventName : 'consent_' + data.command,
    'consent_state':          mergedState,
    'consent_state_previous': data.includePreviousState ? previousState : undefined,
  };
}

function getNewConsentState() {  
  const getTypeState = consent => ({
    'true':    'granted',
    'granted': 'granted',
    'false':   'denied',
    'denied':  'denied'
  }[consent]);
  
  const consentSource = data.getStateFromVar ? data.consentStateVar : data;
  const consentState = {};
  
  consentTypes.forEach(consentType => {
    const typeState = getTypeState(consentSource[consentType]);
    if (typeState) consentState[consentType] = typeState;
  });
  
  const regions = getRegions();
  if (regions) consentState.region = regions;
  
  const waitForUpdate = getWaitForUpdate();
  if (waitForUpdate) consentState.wait_for_update = waitForUpdate;
  
  return consentState;
}

function getRegions() {
  if (data.command !== 'default')
    return false;
  
  if (!data.includeEEA && !data.regions)
    return false;
  
  if (data.includeEEA && !data.regions)
    return regionsEEA;
  
  const regionsInput = data.regions.split(',').map(r => r.trim().toUpperCase());
  
  if (data.includeEEA)
    return regionsInput.concat(regionsEEA).filter((r, i, self) => r && self.indexOf(r) === i);
  
  return regionsInput;
}

function getWaitForUpdate() {
  return data.waitForUpdate ? makeInteger(data.wait_for_update) : false;
}

function activateIntegrations(consentState) {
  // Microsoft Clarity
  if (data.extMsClarity) {
    if (consentState.analytics_storage === 'granted') {
      const clarityIsDefined = require('copyFromWindow')('clarity');
      if (clarityIsDefined)
        require('callInWindow')('clarity', 'consent');
      else
        require('createArgumentsQueue')('clarity', 'clarity.q')('consent');
    }
  }
  // Microsoft Advertising
  if (data.extMsAdvertising) {
    require('createQueue')('uetq')('consent', data.command, { 'ad_storage': consentState.ad_storage || 'denied' });
  }
  // Microsoft Invest
  if (data.extMsInvest) {
    const msInvestConsent = { 'ad_storage': consentState.ad_storage };
    const waitForUpdate = getWaitForUpdate();
    if (waitForUpdate) msInvestConsent.wait_for_update = waitForUpdate;
    require('createQueue')('actionQueue')({
      'action':     'consent',
      'actionValue': data.command,
      'params':      msInvestConsent
    });
  }
}

// Update Consent - Global
const newConsentState = getNewConsentState();
log(data.command + ': ' + newConsentState);
setConsent[data.command](newConsentState);

// URL Passthrough & Ads Data Redaction
gtagSet({
  'url_passthrough':    data.url_passthrough    || false,
  'ads_data_redaction': data.ads_data_redaction || false
});

// Consent Mode Integrations
activateIntegrations(newConsentState);

// Push Data Layer Event
if (data.dataLayerEvent) {
  const event = getEventMessage(newConsentState);
  require('createQueue')('dataLayer')(event);
}

// Done
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "uetq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "actionQueue"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "clarity"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "clarity.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Consent State - Default
  code: |-
    mockData.waitForUpdate = true;
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          500,
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default (From Variable)
  code: |-
    mockData.getStateFromVar = true;
    mockData.waitForUpdate = true;
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      wait_for_update:          500,
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - EEA
  code: |-
    mockData.includeEEA = true;
    mockData.waitForUpdate = true;
    runCode(mockData);

    // Verify default state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          500,
      region:                   regionsEEA,
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - EEA (From Variable)
  code: |-
    mockData.includeEEA = true;
    mockData.getStateFromVar = true;
    mockData.waitForUpdate = true;
    runCode(mockData);

    // Verify default state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      wait_for_update:          500,
      region:                   regionsEEA,
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - Custom
  code: |-
    mockData.includeEEA = false;
    mockData.waitForUpdate = true;

    // Run 1 - Single Region
    mockData.regions = 'US';
    runCode(mockData);

    // Verify default state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          500,
      region:                   ['US'],
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Run 2 - Multi Region
    mockData.regions = 'US,CA';
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          500,
      region:                   ['US', 'CA'],
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - Custom (From Variable)
  code: |-
    mockData.includeEEA = false;
    mockData.waitForUpdate = true;
    mockData.getStateFromVar = true;
    mockData.includeEEA = false;
    mockData.waitForUpdate = true;

    // Run 1 - Single Region
    mockData.regions = 'US';
    runCode(mockData);

    // Verify default state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      wait_for_update:          500,
      region:                   ['US'],
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Run 2 - Multi Region
    mockData.regions = 'US,CA';
    runCode(mockData);

    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      wait_for_update:          500,
      region:                   ['US', 'CA'],
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - Custom - Including EEA
  code: |-
    mockData.waitForUpdate = true;
    mockData.includeEEA = true;
    mockData.waitForUpdate = true;
    mockData.regions = 'US,CA';
    runCode(mockData);

    // Verify region specific state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          500,
      region:                   ['US', 'CA'].concat(regionsEEA),
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Default - Regional - Custom - Including EEA (From Variable)
  code: |-
    mockData.waitForUpdate = true;
    mockData.getStateFromVar = true;
    mockData.includeEEA = true;
    mockData.waitForUpdate = true;
    mockData.regions = 'US,CA';
    runCode(mockData);

    // Verify region specific state
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      wait_for_update:          500,
      region:                   ['US', 'CA'].concat(regionsEEA),
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Update
  code: |-
    mockData.command = 'update';
    mockData.ad_storage = 'true';
    mockData.ad_user_data = 'granted';
    mockData.ad_user_data = true;
    mockData.analytics_storage = 'granted';
    mockData.ad_personalization = 'denied';
    mockData.personalization_storage = 'false';
    mockData.functionality_storage = false;
    mockData.security_storage = 'INVALID';

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('updateConsentState').wasCalledWith({
      analytics_storage:       'granted',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'denied',
      personalization_storage: 'denied',
      functionality_storage:   'denied',
    });
    assertApi('gtmOnSuccess').wasCalled();
- name: Consent State - Update (From Variable)
  code: |-
    mockData.command = 'update';
    mockData.ad_storage = 'true';
    mockData.ad_user_data = 'granted';
    mockData.ad_user_data = true;
    mockData.analytics_storage = 'granted';
    mockData.ad_personalization = 'denied';
    mockData.personalization_storage = 'false';
    mockData.functionality_storage = false;
    mockData.security_storage = 'INVALID';
    mockData.getStateFromVar = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('updateConsentState').wasCalledWith({
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
    });
    assertApi('gtmOnSuccess').wasCalled();
- name: Additional Settings - Wait For Update
  code: |-
    mockData.waitForUpdate = false;
    mockData.wait_for_update = 0;
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage:              'denied',
      analytics_storage:       'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the tag finished successfully.
    mockData.waitForUpdate = true;
    mockData.wait_for_update = 0;
    runCode(mockData);
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage:              'denied',
      analytics_storage:       'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the tag finished successfully.
    mockData.waitForUpdate = true;
    mockData.wait_for_update = 1.0;
    runCode(mockData);
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage:              'denied',
      analytics_storage:       'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          1,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the tag finished successfully.
    mockData.waitForUpdate = true;
    mockData.wait_for_update = '0001';
    runCode(mockData);
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage:              'denied',
      analytics_storage:       'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          1,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the tag finished successfully.
    mockData.waitForUpdate = true;
    mockData.wait_for_update = '100';
    runCode(mockData);
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage:              'denied',
      analytics_storage:       'denied',
      ad_user_data:            'denied',
      ad_personalization:      'denied',
      wait_for_update:          100,
    });
    assertApi('gtmOnSuccess').wasCalled();
- name: Additional Settings - URL Passthrough & Ads Data Redaction
  code: |-
    // Both enabled
    mockData.url_passthrough = true;
    mockData.ads_data_redaction = true;
    runCode(mockData);
    assertApi('gtagSet').wasCalledWith({
      url_passthrough: true,
      ads_data_redaction: true,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Only passthrough
    mockData.url_passthrough = true;
    mockData.ads_data_redaction = false;
    runCode(mockData);
    assertApi('gtagSet').wasCalledWith({
      url_passthrough: true,
      ads_data_redaction: false,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Only ads data redaction
    mockData.url_passthrough = false;
    mockData.ads_data_redaction = true;
    runCode(mockData);
    assertApi('gtagSet').wasCalledWith({
      url_passthrough: false,
      ads_data_redaction: true,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Both disabled
    mockData.url_passthrough = false;
    mockData.ads_data_redaction = false;
    runCode(mockData);
    assertApi('gtagSet').wasCalledWith({
      url_passthrough: false,
      ads_data_redaction: false,
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Both disabled
    mockData.url_passthrough = false;
    mockData.ads_data_redaction = false;
    runCode(mockData);
    assertApi('gtagSet').wasCalledWith({
      url_passthrough: false,
      ads_data_redaction: false,
    });
    assertApi('gtmOnSuccess').wasCalled();
- name: Data Layer Event
  code: "mockData.dataLayerEvent = true;\nmockData.includePreviousState = false;\n\
    mockData.waitForUpdate = true;\n\nlet dlCalled = false;\n\nmock('createQueue',\
    \ name => {\n  return e => {\n    let o = e.consent_state;\n    if (e.event ===\
    \ ('consent_' + mockData.command) && \n        o.analytics_storage  === 'denied'\
    \ && \n        o.ad_storage         === 'denied' && \n        o.ad_user_data \
    \      === 'denied' &&\n        o.ad_personalization === 'denied'\n        ) dlCalled\
    \ = true;\n  };\n});\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    // Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertThat(dlCalled, 'dataLayer not called with correct arguments').isEqualTo(true);\n\
    \ndlCalled = false;\nmockData.command = 'update';\nmockData.waitForUpdate = false;\n\
    mockData.ad_storage = 'true';\nmockData.ad_user_data = 'granted';\nmockData.ad_user_data\
    \ = true;\nmockData.analytics_storage = 'granted';\nmockData.includePreviousState\
    \ = true;\n\nmock('createQueue', name => {\n  return e => {\n    let o = e.consent_state;\n\
    \    let p = e.consent_state_previous;\n    if (e.event === ('consent_' + mockData.command)\
    \ && \n        o.analytics_storage  === 'granted' && \n        o.ad_storage  \
    \       === 'granted' && \n        o.ad_user_data       === 'granted' &&\n   \
    \     o.ad_personalization === 'denied'  && \n        p.analytics_storage  ===\
    \ 'denied'  && \n        p.ad_storage         === 'denied'  && \n        p.ad_user_data\
    \       === 'denied'  &&\n        p.ad_personalization === 'denied'\n        )\
    \ dlCalled = true;\n  };\n});\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    // Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertThat(dlCalled, 'dataLayer not called with correct arguments').isEqualTo(true);"
- name: Integration - Microsoft Clarity
  code: |
    mockData.extMsClarity = true;

    let clarityConsentWasSet = false;
    mock('createArgumentsQueue', (fnName, arrName) => (arg) => (clarityConsentWasSet = arg === 'consent'));

    // Clarity Not Defined in Window - Consent Denied
    runCode(mockData);
    assertThat(clarityConsentWasSet, 'Clarity consent was set without proper consent').isEqualTo(false);
    assertApi('gtmOnSuccess').wasCalled();

    // Clarity Not Defined in Window - Consent Granted
    mockData.analytics_storage = 'granted';
    runCode(mockData);
    assertThat(clarityConsentWasSet, 'Clarity consent was not set').isEqualTo(true);
    assertApi('gtmOnSuccess').wasCalled();

    // Mock Clarity in Window
    mock('copyFromWindow', (globName) => globName === 'clarity' && () => {});

    // Clarity Defined in Window - Consent Denied
    mockData.analytics_storage = 'denied';
    runCode(mockData);
    assertApi('callInWindow').wasNotCalledWith('clarity', 'consent');
    assertApi('gtmOnSuccess').wasCalled();

    // Clarity Defined in Window - Consent Granted
    mockData.analytics_storage = 'granted';
    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('clarity', 'consent');
    assertApi('gtmOnSuccess').wasCalled();
- name: Integration - Microsoft Advertising (UET)
  code: |-
    mockData.extMsAdvertising = true;
    mockData.ad_storage = 'denied';

    let msCommand;
    let msConsent;

    mock('createQueue', (fnName) => {
      if (fnName === 'uetq')
        return (_, command, consent) => {
          msCommand = command;
          msConsent = consent;
        };
    });


    runCode(mockData);
    assertThat(msCommand, 'Incorrect command!').isEqualTo('default');
    assertThat(msConsent, 'Incorrect consent!').isEqualTo({ ad_storage: 'denied' });
    assertApi('gtmOnSuccess').wasCalled();

    mockData.command = 'update';
    mockData.ad_storage = 'granted';
    mockData.wait_for_update = false;
    runCode(mockData);
    assertThat(msCommand, 'Incorrect command!').isEqualTo('update');
    assertThat(msConsent, 'Incorrect consent!').isEqualTo({ ad_storage: 'granted' });
    assertApi('gtmOnSuccess').wasCalled();
- name: Integration - Microsoft Invest
  code: |-
    mockData.extMsInvest = true;

    let msInvestSettings;

    mock('createQueue', (fnName) => {
      if (fnName === 'actionQueue')
        return (arg) => { msInvestSettings = arg; };
    });

    // Default - Ad Storage Denied & Wait for Update
    mockData.ad_storage = 'denied';
    mockData.waitForUpdate = true;
    runCode(mockData);
    assertThat(msInvestSettings, 'Incorrect command!').isEqualTo({
      'action':      'consent',
      'actionValue': 'default',
      'params': {
        'ad_storage': 'denied',
        'wait_for_update': 500
       }
    });
    assertApi('gtmOnSuccess').wasCalled();

    // Update - Ad Storage Granted
    mockData.command = 'update';
    mockData.ad_storage = 'granted';
    mockData.waitForUpdate = false;
    runCode(mockData);
    assertThat(msInvestSettings, 'Incorrect command!').isEqualTo({
      'action':      'consent',
      'actionValue': 'update',
      'params': {
        'ad_storage': 'granted'
       }
    });
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  let mockData = {
    command: 'default',
    // Default Consent
    analytics_storage:       'denied',
    ad_storage:              'denied',
    ad_user_data:            'denied',
    ad_personalization:      'denied',
    personalization_storage:  undefined,
    functionality_storage:    undefined,
    security_storage:         undefined,
    // Default Consent (From Variable)
    getStateFromVar: false,
    consentStateVar: {
      analytics_storage:       'denied',
      ad_storage:              'granted',
      ad_user_data:            'granted',
      ad_personalization:      'granted',
      personalization_storage:  undefined,
      functionality_storage:    undefined,
      security_storage:         undefined,
    },
    // Additional Settings
    waitForUpdate:       false,
    wait_for_update:     500,
    url_passthrough:     true,
    ads_data_redaction:  true,
    pushDataLayerEvent:  false,
    // External consent
    extMsClarity:     false,
    extMsInvest:      false,
    extMsAdvertising: false,
  };
  const regionsEEA = [
    'AT',
    'BE',
    'BG',
    'HR',
    'CY',
    'CZ',
    'DK',
    'EE',
    'FI',
    'FR',
    'DE',
    'GR',
    'HU',
    'IE',
    'IT',
    'LV',
    'LT',
    'LU',
    'MT',
    'NL',
    'PL',
    'PT',
    'RO',
    'SK',
    'SI',
    'ES',
    'SE',
    'NO',
    'IS',
    'LI'
  ];


___NOTES___

Created on 2/23/2025, 8:44:41 PM


